<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wartungsportal Generatoren</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f4f6f9; margin: 40px; }
    button { display: block; margin: 10px auto; padding: 12px; width: 260px; border-radius: 10px; border: none; background: #4a90e2; color: white; font-size: 16px; cursor: pointer; }
    button:hover { background: #357ABD; }
    input, textarea, select { width: 90%; margin: 8px 0; padding: 8px; }
    .hidden { display: none; }
    #list, #form, #closeForm { background: white; padding: 15px; border-radius: 12px; margin-top: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .entry { border-bottom: 1px solid #ddd; padding: 8px; text-align: left; }
    .status { width: 15px; height: 15px; display: inline-block; margin-left: 8px; border-radius: 3px; }
  </style>
</head>
<body>
  <h1>Wartungsportal Generatoren</h1>

  <button onclick="window.open('https://drive.google.com/file/d/1Pqe6DCpG8WYtwVL_SeYGbe1bWGzqlgUy/view?usp=drive_link','_blank')">Wartungsanleitung</button>
  <button onclick="toggle('form')">Zwischenfall erfassen</button>
  <button onclick="loadIncidents()">Protokoll</button>
  <button onclick="toggle('closeForm')">Zwischenfall schließen</button>

  <!-- Zwischenfall erfassen -->
  <div id="form" class="hidden">
    <h3>Zwischenfall erfassen</h3>
    <input id="inventar" placeholder="Inventar Nr.">
    <input id="art" placeholder="Art des Zwischenfalls">
    <textarea id="beschreibung" placeholder="Beschreibung"></textarea>
    <button onclick="addIncident()">Absenden</button>
  </div>

  <!-- Zwischenfall schließen -->
  <div id="closeForm" class="hidden">
    <h3>Zwischenfall schließen</h3>
    <select id="incidentSelect" onchange="showCloseFields()"></select>
    <div id="closeFields" class="hidden">
      <textarea id="closeBeschreibung" placeholder="Abschluss-Beschreibung"></textarea>
      <input id="visum" placeholder="Visum (Name)">
      <button onclick="closeIncident()">Schließen</button>
    </div>
  </div>

  <!-- Protokoll -->
  <div id="list" class="hidden">
    <h3>Protokoll</h3>
    <div id="entries"></div>
  </div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwXD23MjAOOEpNocTeSvmvoosoBmiAt8TMzbOr-R-E1nkVA7wiMcgzszWi7yIjJvCWWmg/exec"; //  Google Script

function toggle(id) {
  document.getElementById('form').classList.add('hidden');
  document.getElementById('closeForm').classList.add('hidden');
  document.getElementById('list').classList.add('hidden');
  if (id) document.getElementById(id).classList.remove('hidden');
  if (id === 'closeForm') loadOpenIncidents();
}

// Zwischenfall erfassen
async function addIncident() {
  const data = {
    inventar: document.getElementById('inventar').value,
    art: document.getElementById('art').value,
    beschreibung: document.getElementById('beschreibung').value
  };
  await fetch(API_URL, {method:"POST", body:JSON.stringify(data)});
  alert("Zwischenfall erfasst");
  toggle('');
}

// Protokoll laden
async function loadIncidents() {
  toggle('list');
  const container = document.getElementById('entries');
  container.innerHTML = "<p>Lade Daten...</p>";

  try {
    const res = await fetch(API_URL);
    const data = await res.json();
    console.log("API-Daten (Protokoll):", data);

    container.innerHTML = "";
    if (!data.length) {
      container.innerHTML = "<p>Keine Einträge vorhanden.</p>";
      return;
    }

    data.forEach(inc => {
      let div = document.createElement("div");
      div.className = "entry";
      let statusBox = `<span class="status" style="background:${(inc.Status||'').toString().trim().toLowerCase()==='geschlossen'?'green':'red'}"></span>`;
      let visum = (inc.Status||'').toString().trim().toLowerCase()==="geschlossen"
        ? ` | Visum: ${inc.Visum} <button onclick="alert('${inc['Abschluss-Beschreibung']}')">Details</button>`
        : "";
      div.innerHTML = `${inc.Art} | Inventar: ${inc.Inventar} ${visum} ${statusBox}`;
      container.appendChild(div);
    });
  } catch (err) {
    container.innerHTML = `<p style="color:red;">Fehler: ${err.message}</p>`;
    console.error("API Fehler:", err);
  }
}

// Offene Zwischenfälle ins Dropdown
async function loadOpenIncidents() {
  const select = document.getElementById('incidentSelect');
  const closeFields = document.getElementById('closeFields');
  closeFields.classList.add('hidden');
  select.innerHTML = "";

  try {
    const res = await fetch(API_URL);
    const data = await res.json();
    console.log("API-Daten (Schließen):", data);

    const offene = data.filter(inc => 
      inc.Status && inc.Status.toString().trim().toLowerCase() === "offen"
    );
    console.log("Gefundene offene:", offene);

    if (!offene.length) {
      let opt = document.createElement("option");
      opt.textContent = "Keine offenen Zwischenfälle";
      opt.value = "";
      select.appendChild(opt);
      return;
    }

    let opt0 = document.createElement("option");
    opt0.textContent = "-- Zwischenfall auswählen --";
    opt0.value = "";
    select.appendChild(opt0);

    offene.forEach(inc => {
      let opt = document.createElement("option");
      opt.value = JSON.stringify({inventar: inc.Inventar, art: inc.Art});
      opt.textContent = inc.Art + " (Inventar " + inc.Inventar + ")";
      select.appendChild(opt);
    });
  } catch (err) {
    console.error("Fehler beim Laden offener Zwischenfälle:", err);
  }
}

// Felder einblenden nach Auswahl
function showCloseFields() {
  const val = document.getElementById('incidentSelect').value;
  if (val) {
    document.getElementById('closeFields').classList.remove('hidden');
  } else {
    document.getElementById('closeFields').classList.add('hidden');
  }
}

// Zwischenfall schließen
async function closeIncident() {
  const val = document.getElementById('incidentSelect').value;
  if (!val) {
    alert("Bitte einen Zwischenfall auswählen.");
    return;
  }

  const selected = JSON.parse(val);
  const besch = document.getElementById('closeBeschreibung').value.trim();
  const visum = document.getElementById('visum').value.trim();

  if (!besch || !visum) {
    alert("Bitte alle Felder ausfüllen!");
    return;
  }

  const data = {
    inventar: selected.inventar,
    art: selected.art,
    closeBeschreibung: besch,
    visum: visum
  };

  await fetch(API_URL + "?action=closeIncident", {method:"POST", body:JSON.stringify(data)});
  alert("Zwischenfall geschlossen");
  toggle('');
}
</script>
</body>
</html>
